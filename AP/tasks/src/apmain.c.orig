#include "FreeRTOS.h"
#include "task.h"
#include "timers.h"

#include <stm32l452xx.h>
#include "stm32l4xx_ll_gpio.h"
#include "stm32l4xx_ll_tim.h" // pour mise au point
#include "stm32l4xx_hal.h"    // pour mise au point

#include "aux_usart.h"
#include "service.h"

#include "motor.h"
#include "mems.h"
#include "apdialog.h"
#include "autopilot.h"

void taskBlink(void *param)
/*
 * \brief Blinks the green LED on the Nucleo board.
 * This task is used for debugging and to check if the system is running.
 */
{
    (void)param;
    unsigned cnt; // pour mise au point

    for(;;) {

        LL_GPIO_SetOutputPin(GPIOA, LL_GPIO_PIN_5);
        vTaskDelay(pdMS_TO_TICKS(100));

        LL_GPIO_ResetOutputPin(GPIOA, LL_GPIO_PIN_5);
        vTaskDelay(pdMS_TO_TICKS(200));

        LL_GPIO_SetOutputPin(GPIOA, LL_GPIO_PIN_5);
        vTaskDelay(pdMS_TO_TICKS(100));

        LL_GPIO_ResetOutputPin(GPIOA, LL_GPIO_PIN_5);
        vTaskDelay(pdMS_TO_TICKS(600));

        cnt = TIM3->CNT;

        (void)cnt;
    }
}

void apmain()
{
    int ret;

    init_taskMotor();
    init_taskMEMs();
    init_taskDialogIn();
    init_taskAutoPilot();
    init_taskService();

    ret = xTaskCreate(taskMotor, "Motor", configMINIMAL_STACK_SIZE + 500, (void *)0, 3, (void *)0);
    ret = xTaskCreate(taskMEMs, "MEMs", configMINIMAL_STACK_SIZE + 1000, (void *)0, 4, (void *)0);
    ret = xTaskCreate(taskDialogIn, "Dialog", configMINIMAL_STACK_SIZE + 500, (void *)0, 2, (void *)0);
    ret = xTaskCreate(taskAutoPilot, "Auto Pilot", configMINIMAL_STACK_SIZE + 500, (void *)0, 2, (void *)0);
    ret = xTaskCreate(taskService, "SVC", configMINIMAL_STACK_SIZE + 500, (void *)0, 5, (void *)0);
    ret = xTaskCreate(taskBlink, "Blink", configMINIMAL_STACK_SIZE + 200, (void *)0, 2, (void *)0);

    vTaskStartScheduler(); /* Start scheduler, should never return */

    for(;;)
        ;

    (void)ret; // To avoid unused variable warning
}